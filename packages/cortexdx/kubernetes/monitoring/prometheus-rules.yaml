apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cortexdx-alerts
  namespace: cortexdx
  labels:
    app: cortexdx
    release: prometheus
spec:
  groups:
    - name: cortexdx.availability
      interval: 30s
      rules:
        - alert: CortexDxDown
          expr: up{job="cortexdx"} == 0
          for: 5m
          labels:
            severity: critical
            component: cortexdx
          annotations:
            summary: "CortexDx instance is down"
            description: "CortexDx instance {{ $labels.instance }} has been down for more than 5 minutes."

        - alert: CortexDxHighErrorRate
          expr: |
            rate(cortexdx_mcp_requests_total{status=~"5.."}[5m])
            /
            rate(cortexdx_mcp_requests_total[5m])
            > 0.05
          for: 5m
          labels:
            severity: warning
            component: cortexdx
          annotations:
            summary: "High error rate detected"
            description: "CortexDx instance {{ $labels.instance }} has error rate above 5% (current: {{ $value | humanizePercentage }})."

        - alert: CortexDxHealthCheckFailing
          expr: cortexdx_mcp_health_status != 1
          for: 3m
          labels:
            severity: critical
            component: cortexdx
          annotations:
            summary: "Health check failing"
            description: "CortexDx instance {{ $labels.instance }} health check has been failing for 3 minutes."

    - name: cortexdx.performance
      interval: 30s
      rules:
        - alert: CortexDxHighResponseTime
          expr: |
            histogram_quantile(0.95,
              rate(cortexdx_mcp_request_duration_seconds_bucket[5m])
            ) > 2
          for: 10m
          labels:
            severity: warning
            component: cortexdx
          annotations:
            summary: "High response time detected"
            description: "CortexDx instance {{ $labels.instance }} 95th percentile response time is above 2s (current: {{ $value }}s)."

        - alert: CortexDxHighMemoryUsage
          expr: |
            (
              container_memory_working_set_bytes{pod=~"cortexdx-.*"}
              /
              container_spec_memory_limit_bytes{pod=~"cortexdx-.*"}
            ) > 0.85
          for: 5m
          labels:
            severity: warning
            component: cortexdx
          annotations:
            summary: "High memory usage"
            description: "CortexDx pod {{ $labels.pod }} is using more than 85% of its memory limit (current: {{ $value | humanizePercentage }})."

        - alert: CortexDxHighCPUUsage
          expr: |
            rate(container_cpu_usage_seconds_total{pod=~"cortexdx-.*"}[5m])
            /
            container_spec_cpu_quota{pod=~"cortexdx-.*"}
            * 100000 > 85
          for: 10m
          labels:
            severity: warning
            component: cortexdx
          annotations:
            summary: "High CPU usage"
            description: "CortexDx pod {{ $labels.pod }} is using more than 85% of its CPU limit (current: {{ $value }}%)."

    - name: cortexdx.llm
      interval: 30s
      rules:
        - alert: CortexDxLLMBackendDown
          expr: cortexdx_mcp_llm_backend_status != 1
          for: 5m
          labels:
            severity: warning
            component: cortexdx-llm
          annotations:
            summary: "LLM backend unavailable"
            description: "CortexDx instance {{ $labels.instance }} LLM backend ({{ $labels.backend }}) has been unavailable for 5 minutes."

        - alert: CortexDxLLMHighLatency
          expr: |
            histogram_quantile(0.95,
              rate(cortexdx_mcp_llm_inference_duration_seconds_bucket[5m])
            ) > 5
          for: 10m
          labels:
            severity: warning
            component: cortexdx-llm
          annotations:
            summary: "High LLM inference latency"
            description: "CortexDx instance {{ $labels.instance }} LLM inference 95th percentile latency is above 5s (current: {{ $value }}s)."

    - name: cortexdx.storage
      interval: 30s
      rules:
        - alert: CortexDxDiskSpaceRunningOut
          expr: |
            (
              kubelet_volume_stats_available_bytes{persistentvolumeclaim=~"cortexdx-.*"}
              /
              kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~"cortexdx-.*"}
            ) < 0.15
          for: 10m
          labels:
            severity: warning
            component: cortexdx-storage
          annotations:
            summary: "Disk space running out"
            description: "PVC {{ $labels.persistentvolumeclaim }} has less than 15% free space (current: {{ $value | humanizePercentage }})."

        - alert: CortexDxDiskSpaceCritical
          expr: |
            (
              kubelet_volume_stats_available_bytes{persistentvolumeclaim=~"cortexdx-.*"}
              /
              kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~"cortexdx-.*"}
            ) < 0.05
          for: 5m
          labels:
            severity: critical
            component: cortexdx-storage
          annotations:
            summary: "Disk space critical"
            description: "PVC {{ $labels.persistentvolumeclaim }} has less than 5% free space (current: {{ $value | humanizePercentage }})."

    - name: cortexdx.database
      interval: 30s
      rules:
        - alert: CortexDxDatabaseConnectionFailing
          expr: cortexdx_mcp_database_connection_status != 1
          for: 3m
          labels:
            severity: critical
            component: cortexdx-database
          annotations:
            summary: "Database connection failing"
            description: "CortexDx instance {{ $labels.instance }} cannot connect to database for 3 minutes."

        - alert: CortexDxDatabaseSlowQueries
          expr: |
            histogram_quantile(0.95,
              rate(cortexdx_mcp_database_query_duration_seconds_bucket[5m])
            ) > 1
          for: 10m
          labels:
            severity: warning
            component: cortexdx-database
          annotations:
            summary: "Slow database queries"
            description: "CortexDx instance {{ $labels.instance }} database query 95th percentile is above 1s (current: {{ $value }}s)."

    - name: cortexdx.patterns
      interval: 30s
      rules:
        - alert: CortexDxPatternMatchingSlowdown
          expr: |
            histogram_quantile(0.95,
              rate(cortexdx_mcp_pattern_matching_duration_seconds_bucket[5m])
            ) > 3
          for: 10m
          labels:
            severity: warning
            component: cortexdx-patterns
          annotations:
            summary: "Pattern matching slowdown"
            description: "CortexDx instance {{ $labels.instance }} pattern matching 95th percentile is above 3s (current: {{ $value }}s)."

        - alert: CortexDxPatternStorageGrowth
          expr: |
            rate(cortexdx_mcp_pattern_storage_size_bytes[1h]) > 10485760
          for: 1h
          labels:
            severity: info
            component: cortexdx-patterns
          annotations:
            summary: "High pattern storage growth"
            description: "CortexDx instance {{ $labels.instance }} pattern storage is growing at {{ $value | humanize }}B/s (>10MB/h)."
