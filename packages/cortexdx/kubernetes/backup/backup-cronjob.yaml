apiVersion: batch/v1
kind: CronJob
metadata:
  name: cortexdx-backup
  namespace: cortexdx
  labels:
    app: cortexdx
    component: backup
spec:
  # Run daily at 2 AM
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: cortexdx
            component: backup
        spec:
          restartPolicy: OnFailure
          serviceAccountName: cortexdx-backup
          containers:
            - name: backup
              image: brainwav/cortexdx:latest-community
              command: ["/bin/bash", "/app/scripts/backup.sh"]
              env:
                - name: BACKUP_DIR
                  value: "/backups"
                - name: DATA_DIR
                  value: "/app/data"
                - name: PATTERNS_DIR
                  value: "/app/patterns"
                - name: MODELS_DIR
                  value: "/app/models"
                - name: CONFIG_DIR
                  value: "/app/config"
                - name: RETENTION_DAYS
                  value: "30"
                - name: BACKUP_MODELS
                  value: "false"
                - name: BACKUP_REMOTE_URL
                  valueFrom:
                    secretKeyRef:
                      name: backup-secrets
                      key: remote-url
                      optional: true
              volumeMounts:
                - name: data
                  mountPath: /app/data
                  readOnly: true
                - name: patterns
                  mountPath: /app/patterns
                  readOnly: true
                - name: models
                  mountPath: /app/models
                  readOnly: true
                - name: config
                  mountPath: /app/config
                  readOnly: true
                - name: backups
                  mountPath: /backups
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: cortexdx-data-pvc
            - name: patterns
              persistentVolumeClaim:
                claimName: cortexdx-patterns-pvc
            - name: models
              persistentVolumeClaim:
                claimName: cortexdx-models-pvc
            - name: config
              configMap:
                name: cortexdx-config
            - name: backups
              persistentVolumeClaim:
                claimName: cortexdx-backups-pvc

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cortexdx-backup
  namespace: cortexdx
  labels:
    app: cortexdx
    component: backup

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cortexdx-backup
  namespace: cortexdx
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cortexdx-backup
  namespace: cortexdx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cortexdx-backup
subjects:
  - kind: ServiceAccount
    name: cortexdx-backup
    namespace: cortexdx

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cortexdx-backups-pvc
  namespace: cortexdx
  labels:
    app: cortexdx
    component: backup
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 100Gi
  storageClassName: standard

---
apiVersion: v1
kind: Secret
metadata:
  name: backup-secrets
  namespace: cortexdx
  labels:
    app: cortexdx
    component: backup
type: Opaque
stringData:
  # Set your remote backup URL (S3, GCS, Azure Blob)
  # Examples:
  # S3: s3://my-bucket/cortexdx-backups
  # GCS: gs://my-bucket/cortexdx-backups
  # Azure: https://myaccount.blob.core.windows.net/backups
  remote-url: ""

  # Cloud provider credentials (if needed)
  aws-access-key-id: ""
  aws-secret-access-key: ""
  gcp-service-account-key: ""
  azure-storage-account-key: ""
