# CortexDx Docker Compose Configuration
# Supports Community, Professional, and Enterprise tiers

version: '3.8'

services:
  # Community Edition (Free)
  cortexdx-community:
    build:
      context: ../..
      dockerfile: packages/cortexdx/Dockerfile
    container_name: cortexdx-community
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - CORTEXDX_MCP_TIER=community
      - CORTEXDX_MCP_LOG_LEVEL=info
    volumes:
      - cortexdx-data-community:/app/data
      - cortexdx-logs-community:/app/logs
    restart: unless-stopped
    networks:
      - cortexdx-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Professional Edition
  cortexdx-professional:
    build:
      context: ../..
      dockerfile: packages/cortexdx/Dockerfile
    container_name: cortexdx-professional
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=production
      - CORTEXDX_MCP_TIER=professional
      - CORTEXDX_MCP_LOG_LEVEL=info
      - CORTEXDX_MCP_LICENSE_KEY=${CORTEXDX_LICENSE_KEY}
      - CORTEXDX_MCP_LLM_BACKEND=ollama
      - OLLAMA_HOST=ollama:11434
    volumes:
      - cortexdx-data-pro:/app/data
      - cortexdx-logs-pro:/app/logs
      - cortexdx-models-pro:/app/models
    restart: unless-stopped
    networks:
      - cortexdx-network
    depends_on:
      - ollama
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Enterprise Edition
  cortexdx-enterprise:
    build:
      context: ../..
      dockerfile: packages/cortexdx/Dockerfile
    container_name: cortexdx-enterprise
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=production
      - CORTEXDX_MCP_TIER=enterprise
      - CORTEXDX_MCP_LOG_LEVEL=info
      - CORTEXDX_MCP_LICENSE_KEY=${CORTEXDX_LICENSE_KEY}
      - CORTEXDX_MCP_LLM_BACKEND=ollama
      - OLLAMA_HOST=ollama:11434
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_ENDPOINT}
    volumes:
      - cortexdx-data-enterprise:/app/data
      - cortexdx-logs-enterprise:/app/logs
      - cortexdx-models-enterprise:/app/models
    restart: unless-stopped
    networks:
      - cortexdx-network
    depends_on:
      - ollama
      - postgres
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Ollama LLM Backend (Professional & Enterprise)
  ollama:
    image: ollama/ollama:latest
    container_name: cortexdx-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    restart: unless-stopped
    networks:
      - cortexdx-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # PostgreSQL (Enterprise only)
  postgres:
    image: postgres:16-alpine
    container_name: cortexdx-postgres
    environment:
      - POSTGRES_DB=cortexdx_mcp
      - POSTGRES_USER=cortexdx
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - cortexdx-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cortexdx"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache (Enterprise only)
  redis:
    image: redis:7-alpine
    container_name: cortexdx-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - cortexdx-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  # Community volumes
  cortexdx-data-community:
  cortexdx-logs-community:
  
  # Professional volumes
  cortexdx-data-pro:
  cortexdx-logs-pro:
  cortexdx-models-pro:
  
  # Enterprise volumes
  cortexdx-data-enterprise:
  cortexdx-logs-enterprise:
  cortexdx-models-enterprise:
  
  # Shared volumes
  ollama-models:
  postgres-data:
  redis-data:

networks:
  cortexdx-network:
    driver: bridge
