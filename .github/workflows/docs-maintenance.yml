name: Documentation Maintenance

on:
  # Daily maintenance at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Weekly comprehensive maintenance on Sundays at 3 AM UTC
  schedule:
    - cron: '0 3 * * 0'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      maintenance_type:
        description: 'Type of maintenance to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - version-sync
          - content-freshness
          - link-check
      create_issue:
        description: 'Create GitHub issue for findings'
        required: false
        default: true
        type: boolean

jobs:
  daily-maintenance:
    if: github.event.schedule == '0 2 * * *' || (github.event_name == 'workflow_dispatch' && github.event.inputs.maintenance_type != 'weekly')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g js-yaml
          npm install -g markdownlint-cli2
          npm install -g markdown-link-check
          npm install -g cspell

      - name: Run daily maintenance tasks
        run: |
          echo "Running daily documentation maintenance..."
          
          # Version synchronization check
          node scripts/docs-maintenance.js version-sync
          
          # Quick link health check
          node scripts/docs-maintenance.js link-check
          
          # Generate maintenance report
          node scripts/docs-maintenance.js full

      - name: Check for critical issues
        id: check_issues
        run: |
          if [ -f "docs-maintenance-report.json" ]; then
            errors=$(jq '.summary.errors' docs-maintenance-report.json)
            warnings=$(jq '.summary.warnings' docs-maintenance-report.json)
            
            echo "errors=$errors" >> $GITHUB_OUTPUT
            echo "warnings=$warnings" >> $GITHUB_OUTPUT
            
            if [ "$errors" -gt 0 ]; then
              echo "critical=true" >> $GITHUB_OUTPUT
            else
              echo "critical=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "warnings=0" >> $GITHUB_OUTPUT
            echo "critical=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload maintenance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-maintenance-report-${{ github.run_number }}
          path: |
            docs-maintenance-report.json
            docs-maintenance-report.md
          retention-days: 30

      - name: Create issue for critical findings
        if: steps.check_issues.outputs.critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('docs-maintenance-report.md')) {
              console.log('No maintenance report found');
              return;
            }
            
            const reportContent = fs.readFileSync('docs-maintenance-report.md', 'utf8');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”§ Documentation Maintenance: Critical Issues Found`,
              body: `## Automated Documentation Maintenance Report
            
            This issue was automatically created because critical documentation issues were detected during routine maintenance.
            
            **Run ID:** ${{ github.run_id }}
            **Timestamp:** ${new Date().toISOString()}
            **Errors:** ${{ steps.check_issues.outputs.errors }}
            **Warnings:** ${{ steps.check_issues.outputs.warnings }}
            
            ## Maintenance Report
            
            ${reportContent}
            
            ## Next Steps
            
            1. Review the findings above
            2. Address critical errors first
            3. Consider fixing warnings during next maintenance window
            4. Update documentation as needed
            5. Close this issue once resolved
            
            ---
            *This issue was automatically generated by the documentation maintenance workflow.*`,
              labels: ['documentation', 'maintenance', 'automated']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  weekly-maintenance:
    if: github.event.schedule == '0 3 * * 0' || (github.event_name == 'workflow_dispatch' && github.event.inputs.maintenance_type == 'weekly')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g js-yaml
          npm install -g markdownlint-cli2
          npm install -g markdown-link-check
          npm install -g cspell

      - name: Run comprehensive maintenance
        run: |
          echo "Running comprehensive weekly documentation maintenance..."
          
          # Full maintenance suite
          node scripts/docs-maintenance.js full
          
          # Additional comprehensive checks
          echo "Running extended validation..."
          node scripts/validate-docs.js

      - name: Analyze documentation metrics
        run: |
          echo "Analyzing documentation metrics..."
          
          # Count documentation files
          doc_files=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.nx/*" | wc -l)
          echo "Total documentation files: $doc_files"
          
          # Calculate total documentation size
          doc_size=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.nx/*" -exec wc -c {} + | tail -1 | awk '{print $1}')
          echo "Total documentation size: $doc_size bytes"
          
          # Count TODO items
          todo_count=$(grep -r "TODO\|FIXME\|XXX" --include="*.md" . --exclude-dir=node_modules --exclude-dir=.nx | wc -l)
          echo "TODO items found: $todo_count"
          
          # Save metrics
          cat > docs-metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "files": $doc_files,
            "size_bytes": $doc_size,
            "todo_items": $todo_count,
            "run_id": "${{ github.run_id }}"
          }
          EOF

      - name: Check for outdated content
        run: |
          echo "Checking for potentially outdated content..."
          
          # Find files not updated in 90+ days
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.nx/*" -mtime +90 -ls > stale-files.txt
          
          if [ -s stale-files.txt ]; then
            echo "Found potentially stale files:"
            cat stale-files.txt
          else
            echo "No stale files found"
          fi

      - name: Generate comprehensive report
        run: |
          echo "Generating comprehensive maintenance report..."
          
          # Combine all findings into a comprehensive report
          cat > weekly-maintenance-report.md << 'EOF'
          # Weekly Documentation Maintenance Report
          
          **Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Workflow Run:** ${{ github.run_id }}
          
          ## Summary
          
          This report contains findings from the weekly comprehensive documentation maintenance.
          
          EOF
          
          # Append maintenance report if it exists
          if [ -f "docs-maintenance-report.md" ]; then
            echo "" >> weekly-maintenance-report.md
            echo "## Maintenance Findings" >> weekly-maintenance-report.md
            echo "" >> weekly-maintenance-report.md
            cat docs-maintenance-report.md >> weekly-maintenance-report.md
          fi
          
          # Append metrics if available
          if [ -f "docs-metrics.json" ]; then
            echo "" >> weekly-maintenance-report.md
            echo "## Documentation Metrics" >> weekly-maintenance-report.md
            echo "" >> weekly-maintenance-report.md
            echo "- **Total Files:** $(jq '.files' docs-metrics.json)" >> weekly-maintenance-report.md
            echo "- **Total Size:** $(jq '.size_bytes' docs-metrics.json) bytes" >> weekly-maintenance-report.md
            echo "- **TODO Items:** $(jq '.todo_items' docs-metrics.json)" >> weekly-maintenance-report.md
          fi
          
          # Append stale files if any
          if [ -s stale-files.txt ]; then
            echo "" >> weekly-maintenance-report.md
            echo "## Potentially Stale Files" >> weekly-maintenance-report.md
            echo "" >> weekly-maintenance-report.md
            echo "The following files haven't been updated in 90+ days:" >> weekly-maintenance-report.md
            echo "" >> weekly-maintenance-report.md
            while read -r line; do
              file=$(echo "$line" | awk '{print $NF}')
              echo "- $file" >> weekly-maintenance-report.md
            done < stale-files.txt
          fi

      - name: Upload comprehensive reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-maintenance-report-${{ github.run_number }}
          path: |
            weekly-maintenance-report.md
            docs-maintenance-report.json
            docs-maintenance-report.md
            docs-metrics.json
            stale-files.txt
          retention-days: 90

      - name: Create weekly maintenance issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let reportContent = '## Weekly Maintenance Report\n\nNo detailed report available.';
            
            if (fs.existsSync('weekly-maintenance-report.md')) {
              reportContent = fs.readFileSync('weekly-maintenance-report.md', 'utf8');
            }
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Weekly Documentation Maintenance Report - ${new Date().toISOString().split('T')[0]}`,
              body: `## Automated Weekly Documentation Maintenance
            
            This is the weekly comprehensive documentation maintenance report.
            
            **Run ID:** ${{ github.run_id }}
            **Timestamp:** ${new Date().toISOString()}
            
            ${reportContent}
            
            ## Actions Required
            
            - [ ] Review maintenance findings
            - [ ] Address any critical issues
            - [ ] Update stale documentation if needed
            - [ ] Plan improvements based on metrics
            
            ## Next Weekly Review
            
            The next automated weekly review will run on ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}.
            
            ---
            *This report was automatically generated by the weekly documentation maintenance workflow.*`,
              labels: ['documentation', 'maintenance', 'weekly-report']
            });
            
            console.log(`Created weekly maintenance issue #${issue.data.number}`);

  manual-maintenance:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g js-yaml
          npm install -g markdownlint-cli2
          npm install -g markdown-link-check
          npm install -g cspell

      - name: Run requested maintenance task
        run: |
          echo "Running manual maintenance task: ${{ github.event.inputs.maintenance_type }}"
          node scripts/docs-maintenance.js ${{ github.event.inputs.maintenance_type }}

      - name: Upload manual maintenance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manual-maintenance-${{ github.event.inputs.maintenance_type }}-${{ github.run_number }}
          path: |
            docs-maintenance-report.json
            docs-maintenance-report.md
          retention-days: 30

      - name: Create issue for manual maintenance
        if: github.event.inputs.create_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let reportContent = 'No maintenance report generated.';
            
            if (fs.existsSync('docs-maintenance-report.md')) {
              reportContent = fs.readFileSync('docs-maintenance-report.md', 'utf8');
            }
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”§ Manual Documentation Maintenance: ${{ github.event.inputs.maintenance_type }}`,
              body: `## Manual Documentation Maintenance Report
            
            **Task:** ${{ github.event.inputs.maintenance_type }}
            **Triggered by:** @${{ github.actor }}
            **Run ID:** ${{ github.run_id }}
            **Timestamp:** ${new Date().toISOString()}
            
            ${reportContent}
            
            ---
            *This issue was created for the manual maintenance task requested by @${{ github.actor }}.*`,
              labels: ['documentation', 'maintenance', 'manual']
            });
            
            console.log(`Created manual maintenance issue #${issue.data.number}`);